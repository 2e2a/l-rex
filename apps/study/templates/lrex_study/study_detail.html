{% extends "lrex_home/base.html" %}
{% load contrib_tags %}
{% load static %}

{% block content %}
{% if not study.is_archived %}
<div class="text-center mb-2">
    {% if allow_publish %}
    <form class="form-inline" method="post">
        {% csrf_token %}
        {% if study.is_published %}
        <button type="submit" name="action" value="unpublish" class="btn btn-warning btn-sm mx-1">Unpublish</button>
        {% else %}
        <button type="submit" name="action" value="publish" class="btn btn-success btn-sm mx-1">Publish</button>
        {% endif %}
    </form>
    {% else %}
    <a href="" class="btn btn-success btn-sm mx-1 disabled">Publish</a>
    {% endif %}
</div>

<div class="row">
    <div class="col-md-4 order-md-2">
        <div class="card my-2">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <h2 class="card-title">Status</h2>
                    <span><img src="{% static 'icons/lightbulb.svg' %}" width="20"></span>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-5">
                        Current status:
                    </div>
                    <div class="col-sm-5">
                        <span class="badge badge-primary">{{ study.status.name }}</span>
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-5">
                        Created:
                    </div>
                    <div class="col-sm-5">
                        {{ study.created_date|date:"SHORT_DATE_FORMAT" }}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-5">
                        Make your study available:
                    </div>
                    <div class="col-sm-5">
                        {% if study.is_published %}
                        <a href="{% url 'trial-intro' study.slug %}">Link for participants</a>
                        {% else %}
                        <a class="card-link text-muted">Link for participants</a>
                        {% endif %}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-5">
                        Password:
                    </div>
                    <div class="col-sm-5">
                        {% if study.password %}
                        {{ study.password }}
                        {% else %}
                        --
                        {% endif %}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-5">
                        Trials completed:
                    </div>
                    <div class="col-sm-5">
                        {{ trial_count_finished }}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-5">
                        Test your study:
                    </div>
                    <div class="col-sm-5">
                        {% if allow_publish %}
                        <a href="{% url 'trial-intro' study.slug %}?test=True">Link for testing</a>
                        {% else %}
                        <a class="card-link text-muted">Link for testing</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="card  my-2">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <h2 class="card-title">Settings</h2>
                    <span><img src="{% static 'icons/cog.svg' %} " width="20"></span>
                </div>
                <p class="card-text">
                    Set the general properties of the study. Share the study with other researchers.
                </p>
                <div class="row small text-secondary">
                    <div class="col-sm-6">
                        Item Type:
                    </div>
                    <div class="col-sm-4">
                        {{ study.get_item_type_display }}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-6">
                        Participant id:
                    </div>
                    <div class="col-sm-4">
                        {{ study.require_participant_id|yesno }}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-6">
                        Participation code:
                    </div>
                    <div class="col-sm-4">
                        {{ study.generate_participation_code|yesno }}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-6">
                        End date:
                    </div>
                    <div class="col-sm-4">
                        {% if study.end_date %}
                        {{ study.end_date|date:"SHORT_DATE_FORMAT" }}
                        {% else %}
                        --
                        {% endif %}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-6">
                        Trial limit:
                    </div>
                    <div class="col-sm-4">
                        {{ study.trial_limit|default:"--" }}
                    </div>
                </div>
                <div class="row small text-secondary">
                    {% if study.creator == view.request.user %}
                    <div class="col-sm-6">
                        Shared with:
                    </div>
                    <div class="col-sm-4">
                        {{ study.shared_with|default:"--" }}
                    </div>
                    {% else %}
                    <div class="col-sm-6">
                        Shared by:
                    </div>
                    <div class="col-sm-4">
                        {{ study.creator.username }}
                    </div>
                    {% endif %}
                </div>
                <hr>
                <a  class="card-link" href="{% url 'study-update' study.slug %}">Settings</a>
                <a  class="card-link" href="{% url 'study-advanced' study.slug %}">Advanced settings</a>
                <a  class="card-link" href="{% url 'study-share' study.slug %}">Share</a>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card my-2">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <h2 class="card-title">Task and instructions</h2>
                    <span><img src="{% static 'icons/question-circle.svg' %} " width="20"></span>
                </div>
                <p class="card-text">
                    Specify one or more questions that the participants will be asked to answer.
                    Add instructions that will explain to your participants what you want them to do in your study.
                </p>
                <div class="row small text-secondary">
                    <div class="col-sm-3">
                        Questions:
                    </div>
                    <div class="col-sm-7 text-truncate">

                        {% for question in study.questions %}
                        {{ question }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                        --
                        {% endfor %}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-3">
                        Instructions:
                    </div>
                    <div class="col-sm-7 text-truncate">
                        {{ study.instructions|default:"--" }}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-3">
                        Intro:
                    </div>
                    <div class="col-sm-7 text-truncate">
                        {{ study.intro|default:"--" }}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-3">
                        Outro:
                    </div>
                    <div class="col-sm-7 text-truncate">
                        {{ study.outro|default:"--" }}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-3">
                        Demographics:
                    </div>
                    <div class="col-sm-7 text-truncate">

                        {% for demographic_field in study.demographicfield_set.all %}
                        {{ demographic_field }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                        --
                        {% endfor %}
                    </div>
                </div>
                <hr>
                <a class="card-link" href="{% url 'study-questions' study.slug %}">Questions</a>
                <a class="card-link" href="{% url 'study-instructions' study.slug %}">Instructions</a>
                <a class="card-link" href="{% url 'study-intro' study.slug %}">Intro/outro</a>
                <a class="card-link" href="{% url 'study-demographics' study.slug %}">Demographics</a>
            </div>
        </div>

        <div class="card my-2">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <h2 class="card-title">Experiments</h2>
                    <span><img src="{% static 'icons/file-upload.svg' %} " width="20"></span>
                </div>
                <p class="card-text">
                    Add materials that the participants will be asked to rate.
                    Decide how the materials will be distributed among participants.
                </p>
                <div class="row small text-secondary">
                    <div class="col-sm-3">
                        Experiments ready:
                    </div>
                    <div class="col-sm-7">

                        {% for experiment in experiments_ready %}
                        {{ experiment }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                        --
                        {% endfor %}

                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-3">
                        Experiments in draft:
                    </div>
                    <div class="col-sm-7">

                        {% for experiment in experiments_draft %}
                        {{ experiment }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                        --
                        {% endfor %}

                    </div>
                </div>
                <hr>
                <a  class="card-link" href="{% url 'experiments' study.slug %}">Experiments</a>
            </div>
        </div>

        <div class="card my-2">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <h2 class="card-title">Questionnaires</h2>
                    <span><img src="{% static 'icons/clipboard-list.svg' %} " width="20"></span>
                </div>
                <p class="card-text">
                    Decide how the materials will be presented within a questionnaire
                    (randomized or in a fixed order).
                </p>
                <div class="row small text-secondary">
                    <div class="col-sm-3">
                        Questionnaires created:
                    </div>
                    <div class="col-sm-7">
                        {{ study.questionnaire_set.count }}
                    </div>
                </div>
                <hr>
                <a  class="card-link" href="{% url 'questionnaires' study.slug %}">Questionnaires</a>
                {% if study.use_blocks %}
                <a  class="card-link" href="{% url 'questionnaire-blocks' study.slug %}">
                    Block instructions
                </a>
                {% endif %}
            </div>
        </div>

        <div class="card my-2">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <h2 class="card-title">Contact and privacy</h2>
                    <span><img src="{% static 'icons/envelope.svg' %} " width="20"></span>
                </div>
                <p class="card-text">
                    Provide information about your study for the participants: how can they contact you and how will
                    their data be handled?
                </p>
                <div class="row small text-secondary">
                    <div class="col-sm-3">
                        Contact:
                    </div>
                    <div class="col-sm-7">
                        {% if study.contact_name %}
                        {{study.contact_name}} ({{study.contact_email}}, {{study.contact_affiliation}})
                        {% else %}
                        --
                        {% endif %}
                    </div>
                </div>
                <div class="row small text-secondary">
                    <div class="col-sm-3">
                        Privacy statement:
                    </div>
                    <div class="col-sm-7 text-truncate">
                        {{ study.privacy_statement|default:"--" }}
                    </div>
                </div>
                <hr>
                <a  class="card-link" href="{% url 'study-contact' study.slug %}">Contact information</a>
                <a  class="card-link" href="{% url 'study-privacy' study.slug %}">Privacy statement</a>
            </div>
        </div>

        <div class="card my-2">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <h2 class="card-title">Results</h2>
                    <span><img src="{% static 'icons/poll.svg' %} " width="20"></span>
                </div>
                <p class="card-text">
                    View a summary of the current results or the completed individual questionnaires. Download all results.
                </p>
                <div class="row small text-secondary small text-secondary">
                    <div class="col-sm-3">
                        Trials active:
                    </div>
                    <div class="col-sm-7">
                        {{ trial_count_active }}
                    </div>
                </div>
                <div class="row small text-secondary small text-secondary">
                    <div class="col-sm-3">
                        Trials completed:
                    </div>
                    <div class="col-sm-7">
                        {{ trial_count_finished }}
                    </div>
                </div>
                <div class="row small text-secondary small text-secondary">
                    <div class="col-sm-3">
                        Trials abandoned:
                    </div>
                    <div class="col-sm-7">
                        {{ trial_count_abandoned }}
                    </div>
                </div>
                <div class="row small text-secondary small text-secondary">
                    <div class="col-sm-3">
                        Test trials:
                    </div>
                    <div class="col-sm-7">
                        {{ trial_count_test }}
                    </div>
                </div>
                <hr>
                <a  class="card-link" href="{{ study.results_url }}">Summary of the results</a>
                <a  class="card-link" href="{% url 'trials' study.slug %}">Individual user trials</a>
                <a  class="card-link" href="{% url 'study-results-csv' study.slug %}">Download results</a>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="p-4 border bg-white">
    Study has been archived. <a href="{% url 'study-archive-restore' study.slug %}">Restore the study?</a>
</div>
{% endif %}
{% endblock %}
